# COMMIT — STAGE CONTRACT

PURPOSE:
  Define the only moment where
  new meaning becomes trusted by the system.

ROLE:
  Commit transforms provisional effects
  into authoritative system belief.

SCOPE:
  This contract governs ONLY commit.
  It does NOT define execution or validation.

---

# STAGE DEFINITION

STAGE:
  NAME: COMMIT
  POSITION: Final stage in RNA execution pipeline

RULE:
  Commit is the only trust boundary.

---

# INPUTS

INPUT:
  PROPOSAL_RECORD
  REVALIDATION_DECISION
  EXECUTION_EFFECTS_LOG

RULE:
  Commit may only act on
  explicitly approved effects.

---

# REVALIDATION OUTCOME → COMMIT MODE

RULE:
  COMMIT_MODE is derived from REVALIDATION outcome.

MAPPING:
  outcome: APPROVE_COMMIT  -> COMMIT_MODE: FULL
  outcome: PARTIAL_COMMIT  -> COMMIT_MODE: PARTIAL

---

# ALLOWLIST SEMANTICS

RULE:
  commitAllowList is meaningful ONLY in PARTIAL mode.

FULL_MODE_RULE:
  IF outcome == APPROVE_COMMIT
  THEN commitAllowList MUST be ignored by COMMIT logic.

NOTE:
  The system MAY accept commitAllowList as input for compatibility,
  but it must not affect what is committed in FULL mode.

PARTIAL_MODE_RULE:
  IF outcome == PARTIAL_COMMIT
  THEN commitAllowList is authoritative for selecting commit candidates.

PARTIAL_EMPTY_ALLOWLIST_RULE:
  IF outcome == PARTIAL_COMMIT AND commitAllowList is empty
  THEN COMMIT MUST commit nothing AND MUST still emit a COMMIT_RECORD.

---

# ELIGIBILITY RULE (MINIMAL V1)

RULE:
  Only PROVISIONAL produced objects are eligible for promotion in this stage.

FORBIDDEN:
  - committing UNTRUSTED objects
  - re-committing already COMMITTED objects
  - deriving new objects inside COMMIT (no new execution)

---

# REQUIRED PRECOMMIT GUARD

RULE:
  COMMIT must not interpret raw input directly.

REQUIRE:
  A PRECOMMIT_GUARD must run before any promotions are attempted.

PRECOMMIT_GUARD_OUTPUT:
  - parsed CommitInput (canonical)
  - COMMIT_MODE: FULL | PARTIAL
  - ELIGIBLE_EFFECTS: list of eligible effects to promote
  - HALT_REASON on failure (fail-closed)

RULE:
  COMMIT_STAGE may only iterate over COMMIT_SET produced by the guard.

---

# OUTPUTS

OUTPUT:
  COMMIT_RECORD
  TRUST_UPDATES

COMMIT_RECORD_MUST_CONTAIN:
  - commit_id
  - proposal_id
  - effects_log_id
  - committed_objects
  - promotions
  - timestamp
  - actor_attribution (system)
  - approvedEffects
  - rejectedEffects
  - justification

TRUST_UPDATES_MUST:
  - promote provisional objects to COMMITTED
  - update meaning-level state accordingly

NOTE: justification.mode - FULL ignores allowlist, PARTIAL uses it

---

# PROMOTION RECORDS

RULE:
  Every committed object MUST have a corresponding promotion record.

PROMOTION_1_TO_1_RULE:
  For each committedObject:
    - exactly one TrustPromotionRecord exists

TrustPromotionRecord MUST include:
  - objectId
  - from: PROVISIONAL
  - to: COMMITTED
  - stage: COMMIT
  - proposalId
  - effectsLogId
  - commitId
  - reason

---

# RESPONSIBILITIES

THIS_STAGE_MUST:
  - commit only approved effects
  - escalate trust explicitly
  - update system meaning atomically
  - record irreversible decisions

THIS_STAGE_MUST_NOT:
  - execute new actions
  - reinterpret validation
  - bypass constraints
  - create meaning outside justification

RULE:
  Commit is decisive and final.

---

# FAILURE BEHAVIOR

FAILURE_ALLOWED_ONLY_IF:
  - preconditions are unmet
  - inconsistency detected
  - atomicity cannot be guaranteed

FAILURE_MODE:
  HARD STOP

FAILURE_MEANS:
  - no trust is escalated
  - provisional state remains intact

---

# STAGE INVARIANTS

INVARIANT_1:
  Commit is atomic at the meaning level.

INVARIANT_2:
  Commit is irreversible at the trust boundary.

INVARIANT_3:
  Commit is the only creator of COMMITTED meaning.

---

# TRUST MODEL

TRUST_LEVEL:
  TRUSTED

RULE:
  After commit, the system must act
  as if the committed meaning is true.

---

# AUDITABILITY

AUDIT_REQUIREMENT:
  The system MUST be able to answer:
    - what became trusted?
    - why was it allowed?
    - who approved it?
    - how can trust be revoked?

---

# ONE LINE SPINE

STATEMENT:
  "Commit is where the system agrees
   to believe what happened."

---

# SUPER SIMPLE

SUMMARY:
  Approve.
  Promote.
  Record.

END